/*** CALCKE ***/
%LET BY=SUB TRT;
%*PLOT(NEW, LOGCONC, TIME, &BY, I)
RUN;

/*********
%RITEDATA(NEW, NEW, SUB TRT KE_FIRST KE_LAST)
RUN;      ******/

%LET BY=SUB TRT PER SEQ;
%SORTDS(NEW, &BY)
RUN;

%PRINT(NEW, NEW)
RUN;


/* CALCULATE NEW KE */
DATA KEDS;
SET NEW;
   IF I>=KE_FIRST AND I<=KE_LAST;

%LET BY=SUB TRT PER SEQ;
%SORTDS(KEDS, &BY)
RUN;

PROC REG DATA=KEDS NOPRINT OUTEST=KEOUT;
MODEL LOGCONC=TIME;
BY SUB TRT PER SEQ;

RUN;



/* NEW KE IS STORED IN NEW4KE */
DATA KEOUT;
SET KEOUT;
TIME=ABS(TIME);
KEEP SUB TRT PER SEQ TIME;
RENAME TIME=NEWKE;



/* CALCULATE NEW AUCI USING NEW KE */
DATA BASE;
SET NEW;
IF I=NO_ASSAY;


%LET BY=SUB TRT PER SEQ;
%SORTDS(BASE, &BY)
RUN;
DATA BASE;
SET BASE;
DROP AUCT AUCI CMAX TMAX KE THALF;

%PRINT(BASE, BASE)
RUN;
%LET BY=SUB TRT PER SEQ;
%SORTDS(KEOUT, &BY)
RUN;
%PRINT(KEOUT, KEOUT)
RUN;



DATA BASE;
MERGE BASE KEOUT;
BY SUB TRT PER SEQ;
NEWAUCI=NEWAUCT+CLAST/NEWKE;

* &EXC_SUB;

LNEWAUCT=LOG(NEWAUCT);
LNEWAUCI=LOG(NEWAUCI);
LNEWCMAX=LOG(NEWCMAX);
NEWTHALF=LOG(2)/NEWKE;
AUCRATIO=NEWAUCT/NEWAUCI;
OUTPUT;


DATA BASE;
SET BASE;
RENAME NEWAUCT=AUCT NEWAUCI=AUCI NEWCMAX=CMAX NEWTMAX=TMAX
NEWKE=KE NEWTHALF=THALF LNEWAUCT=LAUCT LNEWAUCI=LAUCI
LNEWCMAX=LCMAX;
%LET TITLE=SUMMARY OF PARAMETERS;
%PRINT(BASE, &TITLE)
RUN;
